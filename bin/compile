#!/usr/bin/env bash

echo "-----> APT GET SOME PACKAGE"

pip install numpy

BUILD=$1
CACHE=$2

APT_CACHE_DIR="$2/apt/cache"
APT_STATE_DIR="$2/apt/state"

mkdir -p "$APT_CACHE_DIR/archives/partial"
mkdir -p "$APT_STATE_DIR/lists/partial"

APT_OPTIONS="-o debug::nolocking=true -o dir::cache=$APT_CACHE_DIR -o dir::state=$APT_STATE_DIR"

apt-get $APT_OPTIONS update
apt-get $APT_OPTIONS -y --allow-download=true -d install --reinstall cmake python3-dev python3-numpy

export PATH="$1/.apt/usr/bin:$PATH"
export LD_LIBRARY_PATH="$1/.apt/lib/x86_64-linux-gnu:$1/.apt/usr/lib/x86_64-linux-gnu:$1/.apt/usr/lib/i386-linux-gnu:$1/.apt/usr/lib:$LD_LIBRARY_PATH"
export LIBRARY_PATH="$1/.apt/lib/x86_64-linux-gnu:$1/.apt/usr/lib/x86_64-linux-gnu:$1/.apt/usr/lib/i386-linux-gnu:$1/.apt/usr/lib:$LIBRARY_PATH"
export INCLUDE_PATH="$1/.apt/lib/x86_64-linux-gnu:$1/.apt/usr/include:$1/.apt/usr/include/x86_64-linux-gnu:$INCLUDE_PATH"

mkdir -p $1/.apt

for DEB in $(ls -1 $APT_CACHE_DIR/archives/*.deb); do
  dpkg -x $DEB $1/.apt/
done

export PATH="$1/.apt/usr/bin:$PATH"
export LD_LIBRARY_PATH="$1/.apt/usr/lib/x86_64-linux-gnu:$1/.apt/usr/lib:$LD_LIBRARY_PATH"
export LIBRARY_PATH="$1/.apt/lib/x86_64-linux-gnu:$1/.apt/usr/lib/x86_64-linux-gnu:$1/.apt/usr/lib/i386-linux-gnu:$1/.apt/usr/lib:$LIBRARY_PATH"
export INCLUDE_PATH="$1/.apt/usr/include:$1/.apt/usr/include/x86_64-linux-gnu:$INCLUDE_PATH"

echo "-----> BUILDING OPENCV"

cd $2
wget -qN https://github.com/Itseez/opencv/archive/3.2.0.zip
unzip -o 3.2*.zip
cd opencv*
rm -rf release
mkdir release
cd release
cmake \
-DBUILD_TIFF=ON \
-DBUILD_opencv_java=OFF \
-DWITH_CUDA=OFF \
-DENABLE_AVX=OFF \
-DWITH_OPENGL=OFF \
-DWITH_OPENCL=ON \
-DWITH_IPP=OFF \
-DWITH_TBB=OFF \
-DWITH_EIGEN=OFF \
-DWITH_V4L=OFF \
-DWITH_VTK=OFF \
-DBUILD_TESTS=OFF \
-DBUILD_PERF_TESTS=OFF \
-DCMAKE_BUILD_TYPE=RELEASE \
-DBUILD_opencv_python2=OFF \
-DBUILD_opencv_python3=ON \
-DPYTHON3_EXECUTABLE=$(which python3) \
-DPYTHON3_INCLUDE_DIR=$1/.apt/usr/include/python3.5m \
-DPYTHON3_PACKAGES_PATH=$1/.apt/usr/lib/python3/dist-packages \
-DPYTHON_LIBRARY=$1/.apt/usr/lib/x86_64-linux-gnu/libpython3.5m.so \
-DPYTHON3_NUMPY_INCLUDE_DIRS =$1/.apt/usr/lib/python3/dist-packages/numpy/core/include/ \
..

make -j4 opencv_python3

DESTDIR=$1 make installopencv_python3

echo "-----> setting PATHS for opencv"

mkdir -p .profile.d
cat << EOF > .profile.d/opencv.sh
export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/app/vendor/opencv/lib
export PYTHONPATH=$PYTHONPATH:/app/vendor/opencv/lib/python3.6/site-packages/
EOF

echo "-----> oki"
